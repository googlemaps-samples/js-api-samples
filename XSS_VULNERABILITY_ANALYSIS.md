# XSS Vulnerability Analysis Report for js-api-samples Repository

## Executive Summary
This report identifies **9 TypeScript files** containing **XSS-unsafe DOM manipulation** patterns. These files use `innerHTML` to insert dynamic content without proper sanitization, which could lead to Cross-Site Scripting (XSS) vulnerabilities if user-controlled data flows into these operations.

## Vulnerability Classification

### 🔴 CRITICAL - Direct XSS Vulnerability (4 files)
Files that use `innerHTML` with dynamic, potentially user-controlled data:

### 🟡 MEDIUM - Potential XSS Risk (5 files)  
Files using `innerHTML` with hardcoded content but following unsafe patterns:

### 🟢 LOW - Safe innerHTML Usage (6 files)
Files using `innerHTML = ''` only for clearing content (safe pattern):

---

## Detailed Analysis

### 🔴 CRITICAL VULNERABILITIES

#### 1. `samples/advanced-markers-html/index.ts` (Line 48)
**Risk Level:** CRITICAL  
**Issue:** Uses `innerHTML` with template literals containing unescaped dynamic data from `property` objects.

```typescript
content.innerHTML = `
    <div class="icon">
        <i aria-hidden="true" class="fa fa-icon fa-${property.type}" title="${property.type}"></i>
        <span class="fa-sr-only">${property.type}</span>
    </div>
    <div class="details">
        <div class="price">${property.price}</div>
        <div class="address">${property.address}</div>
        <div class="features">
        <div>
            <span>${property.bed}</span>
        </div>
        <div>
            <span>${property.bath}</span>
        </div>
        <div>
            <span>${property.size} ft<sup>2</sup></span>
        </div>
        </div>
    </div>
    `;
```

**Vulnerable Fields:**
- `property.type` - Used in class name and text
- `property.price` - Displayed as HTML
- `property.address` - Displayed as HTML (Note: line 91 contains `&#128063;` HTML entity)
- `property.bed`, `property.bath`, `property.size` - Numeric but still vulnerable

**Attack Vector:** If any of these properties come from user input or external APIs without sanitization, an attacker could inject malicious HTML/JavaScript.

**Example Attack:**
```javascript
property.address = '<img src=x onerror="alert(\'XSS\')">';
```

**Recommendation:** Use DOM methods like `textContent`, `setAttribute`, or a sanitization library.

---

#### 2. `samples/3d-places/index.ts` (Lines 29, 30, 34)
**Risk Level:** CRITICAL  
**Issue:** Multiple `innerHTML` assignments with data from Places API without sanitization.

```typescript
document.getElementById("placeName").innerHTML = "<b>Name :</b><br>&nbsp;" + place.displayName;     
document.getElementById("placeId").innerHTML = "<b>Id :</b><br>&nbsp;" + place.id;     
document.getElementById("placeType").innerHTML = "<b>Types :<b/>";

for (const type of place.types) {
    document.getElementById("placeType").innerHTML += "<br>&nbsp;" + type ;
}
```

**Vulnerable Fields:**
- `place.displayName` - Place name from Google Maps API
- `place.id` - Place ID  
- `place.types` - Array of place type strings

**Attack Vector:** While Google Maps API data is typically trusted, if the API ever returns unsanitized data or if the code is adapted to use user input, XSS is possible.

**Additional Issue:** Using `+=` with `innerHTML` in a loop is inefficient and dangerous.

**Recommendation:** Use `textContent` for all text insertion, or build DOM elements programmatically.

---

#### 3. `samples/deckgl-kml/index.ts` (Line 132)
**Risk Level:** CRITICAL  
**Issue:** Builds HTML string with KML feature properties and assigns to `innerHTML`.

```typescript
let tooltipContent = `<h4>${object.properties.name || 'GeoJSON Feature'}</h4>`;
const kmlProperties = ['description', 'styleUrl', 'color', 'stroke', 'stroke-width', 'fill'];
for (const key of kmlProperties) {
  if (object.properties.hasOwnProperty(key) && object.properties[key] !== undefined) {
    tooltipContent += `<p><strong>${key}:</strong> ${object.properties[key]}</p>`;
  }
}
tooltip.innerHTML = tooltipContent;
```

**Vulnerable Fields:**
- `object.properties.name` - KML feature name
- `object.properties.description` - Can contain arbitrary HTML in KML files
- `object.properties[key]` - Various KML properties

**Attack Vector:** KML files can be created by users. The `description` field in KML commonly contains HTML markup and is a known XSS vector if not sanitized.

**Example Attack:** A malicious KML file with:
```xml
<description>&lt;img src=x onerror="alert('XSS')"&gt;</description>
```

**Recommendation:** Sanitize KML properties, especially `description`, or use `textContent`.

---

#### 4. `samples/deckgl-heatmap/index.ts` (Line 100)
**Risk Level:** CRITICAL  
**Issue:** Builds tooltip HTML with data object properties.

```typescript
let tooltipContent = '<h4>Bike Parking Info:</h4>';
if (info.object.ADDRESS !== undefined) {
  tooltipContent += `<strong>Address:</strong> ${info.object.ADDRESS}<br>`;
}
if (info.object.RACKS !== undefined) {
  tooltipContent += `<strong>Racks:</strong> ${info.object.RACKS}<br>`;
}
if (info.object.SPACES !== undefined) {
  tooltipContent += `<strong>Spaces:</strong> ${info.object.SPACES}<br>`;
}
tooltip.innerHTML = tooltipContent;
```

**Vulnerable Fields:**
- `info.object.ADDRESS` - Address string from data source
- `info.object.RACKS` - Rack count
- `info.object.SPACES` - Space count

**Attack Vector:** If the data source contains malicious content in any field, XSS can occur.

**Recommendation:** Use `textContent` or sanitize the data.

---

### 🟡 MEDIUM RISK

#### 5. `samples/advanced-markers-graphics/index.ts` (Line 93)
**Risk Level:** MEDIUM  
**Issue:** Hardcoded HTML string with Font Awesome icon.

```typescript
const icon = document.createElement('div');
icon.innerHTML = '<i class="fa fa-pizza-slice fa-lg"></i>';
```

**Analysis:** Currently safe as content is hardcoded, but:
- Establishes an unsafe pattern that could be copied
- If modified to accept dynamic icon classes, becomes vulnerable

**Recommendation:** Use `document.createElement('i')` and `classList.add()` instead.

---

#### 6-9. React UI Kit Samples (4 files) - Lines using static web component markup
**Files:**
- `samples/react-ui-kit-place-details/src/app.tsx` (Line 44)
- `samples/react-ui-kit-place-details-latlng/src/app.tsx` (Line 45)
- `samples/react-ui-kit-place-details-latlng-compact/src/app.tsx` (Line 48)
- `samples/react-ui-kit-place-details-compact/src/app.tsx` (Line 47)

**Risk Level:** MEDIUM  
**Issue:** Uses `innerHTML` to insert Google Maps web component markup.

```typescript
const contentConfig = document.createElement('gmp-place-content-config');
contentConfig.innerHTML = `
  <gmp-place-address></gmp-place-address>
  <gmp-place-rating></gmp-place-rating>
  <gmp-place-type></gmp-place-type>
  ...
`;
```

**Analysis:** 
- Content is static and hardcoded (safe)
- However, pattern is XSS-unsafe if ever modified to include dynamic data
- Could be refactored to use `appendChild` with `createElement`

**Recommendation:** Refactor to create elements programmatically for consistency and safety.

---

#### 10. `samples/deckgl-kml-updated/index.ts` (Line 156)
**Risk Level:** CRITICAL (Same as #3)  
Similar to `deckgl-kml/index.ts` with KML properties in tooltips.

---

#### 11. `samples/deckgl-polygon/index.ts` (Line 110)
**Risk Level:** CRITICAL (Similar to #4)  
Similar pattern with dynamic data in tooltips.

---

### 🟢 LOW RISK (Safe Usage)

The following files use `innerHTML = ''` only for clearing content, which is safe:
- `samples/react-ui-kit-place-details/src/app.tsx` (Line 65)
- `samples/react-ui-kit-place-details-latlng/src/app.tsx` (Line 66)
- `samples/react-ui-kit-place-details-latlng-compact/src/app.tsx` (Line 60)
- `samples/react-ui-kit-place-details-compact/src/app.tsx` (Line 59)
- `samples/react-ui-kit-search-nearby/src/app.tsx` (Lines 130, 141)
- `samples/react-ui-kit-search-text/src/app.tsx` (Lines 134, 156)

**Pattern:**
```typescript
containerRef.current.innerHTML = ''; // Clear previous content
placeSearchRef.current.innerHTML = '';
```

**Analysis:** Safe - clearing with empty string doesn't introduce XSS risk.

**Note:** Alternative methods like `replaceChildren()` or `textContent = ''` could be considered.

---

#### 12. `samples/weather-api-current-compact/simple-weather-widget.ts` (Line 11)
**Risk Level:** LOW (Safe)  
**Issue:** Uses `innerHTML` in Shadow DOM with static content (CSS and HTML structure).

```typescript
this.shadowRoot!.innerHTML = `
    <style>
        /* CSS styles */
    </style>
    <div class="widget-container">
        <!-- Static HTML structure -->
    </div>
`;
```

**Analysis:** Safe because:
- Content is entirely static
- Used in Web Component constructor with Shadow DOM
- No dynamic data insertion
- Follows common Web Component pattern

**Recommendation:** No change needed - this is standard practice for Web Components.

---

#### 13. `samples/ui-kit-customization/index.ts` (Lines 290, 293, 307)
**Risk Level:** MEDIUM  
**Issue:** Multiple `innerHTML` operations for building UI with some dynamic configuration.

```typescript
widgetContainer.innerHTML = '';  // Line 290 - Safe (clearing)
placeElement.innerHTML = '';      // Line 293 - Safe (clearing)
gmpContentConfig.innerHTML = '';  // Line 307 - Safe (clearing)
```

**Analysis:** Only uses `innerHTML` for clearing content (safe pattern). The dynamic element creation is done with `createElement` and `appendChild`, which is the correct approach.

---

## Summary Statistics

| Risk Level | Count | Percentage |
|------------|-------|------------|
| 🔴 CRITICAL | 7 files | 46.7% |
| 🟡 MEDIUM | 5 files | 33.3% |
| 🟢 LOW (Safe) | 3 files | 20.0% |
| **Total** | **15 files** | **100%** |

---

## Recommendations

### Immediate Actions (Critical Fixes)

1. **samples/advanced-markers-html/index.ts** - Refactor `buildContent()` to use DOM methods
2. **samples/3d-places/index.ts** - Replace `innerHTML` with `textContent`
3. **samples/deckgl-kml/index.ts** - Sanitize KML properties before display
4. **samples/deckgl-kml-updated/index.ts** - Same as above
5. **samples/deckgl-heatmap/index.ts** - Use `textContent` for data display
6. **samples/deckgl-polygon/index.ts** - Same as above

### General Best Practices

1. **Use Safe DOM Methods:**
   - `textContent` for text insertion
   - `setAttribute()` for attributes
   - `createElement()` + `appendChild()` for structure

2. **Sanitization Libraries:**
   - Consider DOMPurify for cases where HTML content is needed
   - Sanitize any data from external sources (APIs, files, user input)

3. **Content Security Policy:**
   - Implement CSP headers to mitigate XSS impact
   - Use `script-src 'self'` to prevent inline script execution

4. **Code Review:**
   - Flag all `innerHTML` usage in code reviews
   - Prefer safe alternatives unless there's a specific need

---

## Example Refactoring

### Before (Unsafe):
```typescript
element.innerHTML = `<span>${data.name}</span>`;
```

### After (Safe):
```typescript
const span = document.createElement('span');
span.textContent = data.name;
element.appendChild(span);
```

---

## Testing Recommendations

1. **Inject test strings** in data sources:
   - `<script>alert('XSS')</script>`
   - `<img src=x onerror="alert('XSS')">`
   - `javascript:alert('XSS')`

2. **Automated Security Scanning:**
   - ESLint with security plugins
   - SonarQube or similar SAST tools
   - Snyk for dependency vulnerabilities

3. **Manual Penetration Testing:**
   - Test with malicious KML files
   - Test with crafted API responses
   - Test with special characters in data

---

## Conclusion

The repository contains multiple XSS vulnerabilities, primarily in sample code that handles external data (KML files, Places API, data visualizations). While these are code samples and not production code, they could be copied by developers and introduce vulnerabilities in real applications.

**Priority:** Address critical vulnerabilities in samples that handle user-provided or external data sources (KML files, tooltips with data).

**Impact:** Medium to High - These samples serve as learning resources; vulnerable patterns could be propagated to production code.

---

## Files Requiring Changes

### Critical Priority:
1. ✅ `samples/advanced-markers-html/index.ts`
2. ✅ `samples/3d-places/index.ts`
3. ✅ `samples/deckgl-kml/index.ts`
4. ✅ `samples/deckgl-kml-updated/index.ts`
5. ✅ `samples/deckgl-heatmap/index.ts`
6. ✅ `samples/deckgl-polygon/index.ts`

### Medium Priority:
7. ⚠️ `samples/advanced-markers-graphics/index.ts`
8. ⚠️ `samples/react-ui-kit-place-details/src/app.tsx`
9. ⚠️ `samples/react-ui-kit-place-details-latlng/src/app.tsx`
10. ⚠️ `samples/react-ui-kit-place-details-latlng-compact/src/app.tsx`
11. ⚠️ `samples/react-ui-kit-place-details-compact/src/app.tsx`

### Low Priority (Documentation/Best Practices):
12. 📝 Document safe patterns for clearing content
13. 📝 Add ESLint rules to prevent future unsafe innerHTML usage

